<title>Predict!</title>
<script src="jquery.min.js"></script>
<script>
	$(function() {
		var lastStates = [];
		var predictedPosition = {x: 0, y: 0};
		var indicatorSize = 3;
		var analysisFrames = 10;
		//number of frames to predict
		var predictionFrames = 5;
		
		$('#canvas').attr('height', window.innerHeight).attr('width', window.innerWidth);
		var context = document.getElementById('canvas').getContext('2d');
		
		function showPrediction(e) {
			e.preventDefault();

			var newX = e.pageX || e.originalEvent.touches[0].pageX;
			var newY = e.pageY || e.originalEvent.touches[0].pageY;
			
			lastStates.unshift({x: newX, y: newY, timestamp: +new Date()});

			var velocity = [];
			//analyze last n frames
			for (var i = 0; i < analysisFrames; i++) {
				var a = lastStates[i];
				var b = lastStates[i + 1];
				var dt = a.timestamp - b.timestamp;
				var dx = a.x - b.x;
				var dy = a.y - b.y;
				var dtheta = Math.atan2(dy, dx);
				var dr = Math.sqrt(dx * dx + dy * dy) / dt;
				velocity.push({
					r: dr,
					t: dt,
					theta: dtheta,
				});
			}
			
			var acceleration = [];
			//analyze last n frames
			for (var i = 0; i < velocity.length - 1; i++) {
				var a = velocity[i];
				var b = velocity[i + 1];
				var dtheta = a.theta - b.theta;
				var dr = a.r - b.r;
				acceleration.push({
					r: dr,
					theta: dtheta,
				});
			}
			
			//position: 0   1   2   3   4
			//velocity:   0   1   2   3
			//acceleration: 0   1   2
			
			//simulate future frames
			//this is a crude discrete prediction, using n 16.6ms frames instead of a continuous method
			predictedPosition.x = newX;
			predictedPosition.y = newY;
			
			var step = {
				dr: 0,
				dtheta: 0
			}
			$.each(velocity, function(i, e) {
				step.dr += e.r / velocity.length;
				step.dtheta += e.theta / velocity.length;
			});
			
			var averageAcceleration = {
				r: 0,
				theta: 0
			}
			$.each(acceleration, function(i, e) {
				averageAcceleration.r += e.r / acceleration.length;
				averageAcceleration.theta += e.theta / acceleration.length;
			});
			
			for (var i = 0; i < predictionFrames; i++) {
				context.beginPath();
				context.strokeStyle = 'red';
				context.moveTo(predictedPosition.x, predictedPosition.y);

				step.dr += averageAcceleration.r;
				step.dtheta += averageAcceleration.theta;
				console.log('step dtheta', step.dtheta);
				console.log('cos', Math.cos(dtheta), 'sin', Math.sin(dtheta));
				predictedPosition.x += step.dr * Math.cos(step.dtheta) * 16.67;
				predictedPosition.y += step.dr * Math.sin(step.dtheta) * 16.67;

				context.lineTo(predictedPosition.x, predictedPosition.y);
				context.stroke();
			}
						
			$('#mouse-position').html(
				'<p>' + lastStates[0].x + ', ' + lastStates[0].y + '</p>'
			);
			
			var left = newX - (indicatorSize - 1) / 2;
			var top = newY - (indicatorSize - 1) / 2;

			context.beginPath();
			context.strokeStyle = '#aaa';
			context.moveTo(newX, newY);
			context.lineTo(predictedPosition.x, predictedPosition.y);
			context.stroke();
			
			context.fillStyle = 'green';
			context.fillRect(left, top, indicatorSize, indicatorSize);

			left = predictedPosition.x - (indicatorSize - 1) / 2;
			top = predictedPosition.y - (indicatorSize - 1) / 2;

			context.fillStyle = 'blue';
			context.fillRect(left, top, indicatorSize, indicatorSize);
		}
		$(document).mousemove(showPrediction).bind('touchmove', showPrediction);
	});
</script>
<div id="mouse-position"></div>
<canvas id="canvas" height="100" width="100" style="left:0; position: absolute; top: 0;"></canvas>
